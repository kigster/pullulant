#!/usr/bin/env bash
#_______________________________________________________________________________
#
# (c) 2016-2017 Konstantin Gredeskoul
# https://github.com/kigster/pullulant/
#
# MIT License
#_______________________________________________________________________________

alias gi='gem install'
alias bif='bundle install --full-index'

alias be='bundle exec'
alias bre='bundle exec rspec'
alias bru='bundle exec rubocop'
alias bra='bundle exec rubocop -a'
alias bu='bundle update'

declare -a DEFAULT_RUBY_GEMS=(
  bundler
  irbtools
  warp-dir
  colored2
  sym
  pg
  pry
  pry-doc
  rspec
  rspec-its
  awesome_print
  activesupport
  pivotal_git_scripts
  git-smart
  travis
  awscli
  arli
)

##..................................................................................
##
##    function: ruby.rbenv
## description: Initialize rbenv
##
function ruby.rbenv() {
  if [ -n "$*" ]; then
    rbenv $*
  else
    eval "$(rbenv init - )"
  fi
}

function ruby.gems() {
  if [[ -n "$RUBY_GEMS" ]]; then
    echo "got some ruby-gems: ${RUBY_GEMS}"
    # check if RUBY_GEMS was declared as an array
    if [[ -z $(declare -p RUBY_GEMS 2>/dev/null | grep -E '^declare \-a') ]]; then
      # can not do direct assignment
      local _gems=$RUBY_GEMS
      declare -a RUBY_GEMS=($_gems)
    fi
  else
    declare -a RUBY_GEMS=(${DEFAULT_RUBY_GEMS[@]})
  fi

  local gems=($@)
  local existing=$(gem list)

  [[ ${#gems} -eq 0 ]] && gems=(${RUBY_GEMS[@]})

  printf "${blkcya}installing gems:\n\t${txtrst}"

  local gems_installed=0

  for gem in ${gems[@]}; do
    if [[ "${existing}" =~ "${gem}" ]]; then
      printf "${txtgrn}${gem} ✔ ${txtrst} "
    else
      printf "${txtblu}${gem}${txtrst} "
      gem install -q --force --no-document $gem 1>/dev/null 2>&1
      local result=$?
      if [[ ${result} -eq 0 ]] ; then
        printf "✅  "
      else
        printf "❌  (code=${result}) "
      fi
    fi
    gems_installed=$(($gems_installed + 1))
    [[ $(($gems_installed % 5)) == 0 ]] && printf "\n\t"
  done
  echo
}

function ruby.init() {
  local target="${1:-"${HOME}/.bash_${USER}"}"
  ruby.gems
  set -x
  rbenv rehash
  which warp-dir >/dev/null && warp-dir install --dotfile "${target}"
  which sym >/dev/null && sym -B "${target}"
  set +x
  printf "${bldylw}Now, we'll open a new terminal for you...${clr}\n"
  if [[ -d /Applications/iTerm.app ]] ; then
    open /Applications/iTerm.app
  else
    open /Applications/Utilities/Terminal.app
  fi
}

alias be="bundle exec"
alias brake="rbenv exec bundle exec rake"
alias bcap="rbenv exec bundle exec cap"
