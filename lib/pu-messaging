#!/usr/bin/env bash
#_______________________________________________________________________________
#
# © 2016 Konstantin Gredeskoul
# Project Pullulant™
# https://github.com/kigster/pullulant/
#
# Distributed under MIT License
#_______________________________________________________________________________
#
source "${bash_files_dir}/.bash_colors"

function pu-screen-width {
  stty -a | grep columns | awk '{print $6}'
}

function pu-width {
  echo -n "80"
}

function pu-repeat-char {
  local char=${1:0:1}
  char=${char:- }
  local width=${2:-$(pu-width)}
  for i in {0..1000}; do
    [[ $i -ge ${width} ]] && break
    printf "$char"
  done
}

function pu-line {
  pu-repeat-char "─"
}

function pu-sep {
  pu-line
  printf "\n"
}

# set background color to something before calling this
function pu-bar {
  pu-repeat-char " "
  printf "${txtrst}\n"
}

function pu-clean {
  local text="$*"
  printf "$text" | ruby -npe 'gsub(/\e\[[;m\d]+/, "")'
}

function pu-box-separator {
  printf "├"
  pu-line
  printf "┤\n"
}
function pu-box-top {
  printf "┌"
  pu-line
  printf "┐\n"
}
function pu-box-bottom {
  printf "└"
  pu-line
  printf "┘\n"
}
function pu-box-header {
  local text="$*"
  local width=$(pu-width)
  local uncolored_text=$(pu-clean "$text")
  local remaining_space_len=$(($width - ${#uncolored_text} - 1))
  printf "│ ${text}${txtrst}"
  pu-repeat-char " " $remaining_space_len
  printf "│\n"
}

function pu-cursor-left {
  local cols=$1
  printf "\033[${cols}D"
}

function pu-cursor-right {
  local cols=$1
  printf "\033[${cols}C"
}

function pu-underline-header {
  local title="$*"
  local width=80
  printf "${undylw}%s" "$title"
  local remaining=$(($width - ${#title}))
  printf "%*s${txtrst}\n" $remaining " "
}

function pu-indent-list {
  local list="$1"
  local width="$2"
  local indent="$3"
  echo "$list" | fold -sw $width | sed -E "s/ /, /g; s/(^|$)/${indent}/g; "
}

function pu-git-revision {
  git log --pretty=oneline --abbrev-commit | head -1 | awk '{print $1}'
}

function pu-long-header {
  pu-box-top
  pu-box-header "${bldred}Pullulant ${txtrst} (or just ${bldred}pu${txtrst})                       ${bldylw}(Version $(cat VERSION)) ${txtylw}Git Rev: $(pu-git-revision) "
  pu-box-separator
  pu-box-header "${bldgrn}OS-X Installer for Web Devs, MIT License  | ${txtgrn}(c) 2015-2016 Konstantin Gredeskoul"
  pu-box-header "${bldgrn}https://github.com/kigster/pullulant      |                       http://kig.re"
  pu-box-bottom
}

function pu-short-header {
  printf "${txtrst}"
  pu-box-top
  pu-box-header "${bldgrn}Pullulant ${bldred} ✩ ${txtrst} (or gently: 'pu')                             ${txtblk}${bakpur} Version ${bakblu} $(cat VERSION) ${bakpur}"
  pu-box-bottom
}

function pu-print-options {
  printf "   Enabled Options:${bldylw}\n   "
  count=0
  for option in ${pu_options}; do
    [[ "$option" == "opts_features" ]] && continue
    option_value=$(pu_option_value $option)
    if [[ -n "${option_value/ /}" ]]; then
      [[ $count -gt 0 ]] && printf ", "
      if [[ "$option_value" == "yes" ]]; then
        printf "${bldgrn}%s" ${option/opts_/}
      else
        printf "${bldgrn}%s=${bldylw}%s" ${option/opts_/} ${option_value}
      fi
      count=$(($count + 1))
    fi
  done
  printf "\n"
  pu-line
}

function pu-installers-helpers {
  local installer_list=$(pu-indent-list "$installers" 65 "   ")
  local helper_list=$(pu-indent-list    "$helpers"    65 "   ")

  printf "                                                                                    \n"
  printf "${txtrst}Installers:\n"
  printf "${txtylw}%-68s \n" "$installer_list"
  printf "                                                                                    \n"
  printf "${txtrst}Helpers:\n"
  printf "${txtylw}%-68s \n" "$helper_list"
  printf "                                                                                    \n"

  pu-list-current-runners
}

function pu-list-current-runners {
  linebreak="\n"
  local run_list=$(pu-indent-list "$runners"    65 '   ')
  if [ ! -z "$(echo $run_list | sed 's/[ \n]//g')" ]; then
    printf "${txtrst}Current Run List:\n"
    printf "${bldgrn}%-68s ${txtrst}\n" "$run_list"
  fi
}

function pu-list-features {
  source "lib/pu-features"

  linebreak="\n"
  local run_list=$(pu-indent-list "$(pu-features)"    65 '   ')
  if [ ! -z "$(echo $run_list | sed 's/[ \n]//g')" ]; then
    printf "${txtrst}Current Feature List:\n"
    printf "${txtylw}%-68s ${txtrst}\n" "$run_list"
  fi
  printf "${bakgrn}"
  pu-bar
}

function pu-welcome-screen-short {
  pu-long-header
  printf "\n${txtrst}"
}


function pu-print-section-header {
  [[ -n "${opts_suppress_headers}" ]] && return
  pu-box-top
  pu-box-header "${bldwht}${bakblu}  $*  "
  pu-box-bottom
}

function pu-short-usage {
  printf "
Usage:
  pu  [ -a | -r 'installer helper ...' ]
      [ -A | -t 'feature feature ...'  ]
      [ -SBPLiIRKFCyfqnvlhHxpZT ]
Eg.
  pu -aAy   # installs everything non-interactively
"
}

function pu-short-help {
  printf "
Complete Help:
  pu  [ -h | -H | -x ]

"
}

function pu-print-help {

  pu-short-usage
  printf "
$(pu-underline-header 'Getting Help: ')

  -h          paginated help message in full color
  -H          non-paginated help message in full color
  -x          non-paginated help message in pure ASCII
  -l          list available runners – helpers and installers
  -T          list available features

$(pu-underline-header "Installer and Helper Flags:")

   ${bldgrn}Installers${txtrst} are grouped instructions that deal with a common
              theme, for example 'install_ruby' installs ruby and dependencies.
              To run ALL installers, use the -a flag.

   ${bldgrn}Helpers${txtrst}    are similar to installers, except they are not run as
              part of the full install. They must be invoked by name directly.

  -r 'installer helper  ...'
              run specific installer(s) and/or helper(s) in the provided order
  -l          list available installers and helpers
  -a          full install: runs each installer from the './installers' dir
    -S        [S]proutwrap is disabled during the full install
    -B        [B]rew-upgrade is disabled during the full install
    -P        No backu[P] for rsync of bash and zsh files (default is to backup)

$(pu-underline-header 'Feature Flags:')

  ${bldpur}Features${txtrst}    are a set of brew packages, bash-it plug-ins,
              completions and aliases, defined a particular theme. For
              example, ruby feature enables bash aliases and completions
              releated to all ruby development tools.  It also adds a particulat
              set of brew formulas and casks.

  -t 'feature feature ....'
              Merge packages from a provided set of features.
  -T          List available features
  -A          Merge ALL available features, currently:
              ${bldpur}$(echo $(pu-features))${txtrst}

$(pu-underline-header 'Error Handing:')

              Default error handling is pessimistic: installer stops upon any
              error code returned from a single 'run' statement.
              You can control error handling at two levels:

  -i          [i]gnore errors and continue to the next 'run' statement.

  -I          Stops running the current installer that produced an error, skips
              the rest of it, and continues to the next installer. For example,
              in this mode, if one homebrew package fails to install, the rest
              of homebrew installer will be skipped, and the next installer in
              the run list will begin.

$(pu-underline-header 'Homebrew:')

  -f          [F]orce – applies to some installers, ie. brew (--force) and
              zsh (overwrites current shell to ZSH). Also some rsync
              installers may behave differently with -f.

              -C -F -L flags allow picking specific subset of the install.
              The flags can mix. Adding all three is the same as adding none.

  -L          Only [L]ink packages configured for brew linking
  -C          Only [C]asks are installed from a configured list
  -F          Only [F]ormulas are installed from a configured list

              These apply to all brew commands:
  -R          [R]einstall each formulae during brew install
  -K          Relin[K] all brew formulas/casks during install

$(pu-underline-header 'Zsh')

  -Z          Change the default shell to ZSH and install 'oh-my-zsh'

$(pu-underline-header 'Interaction and Output Control:')

  -y          assume 'yes' to the interactive portion of the runner
  -p          su[p]press pretty section headers for more compact output
  -q          [q]uiet mode: stop printing commands before and after run.
  -v          [v]erbose - show each command's output, and add -v to some
  -n          dry-ru[n] – print commands, but don't actually run them.

$(pu-underline-header 'Examples: ')

  run every installer, with the fully merged set of packages and plugins
  from all available features (probably the most common way to run './pu')
  and skip through the interactive section.
    ${bldgrn}$(basename $0) -aAy${txtrst}

  install everything with the default (small) set of packages:
    ${bldgrn}$(basename $0) -a${txtrst}

  install everything with specific features and plugins enabled
  suitable for ruby,python,node development, as well as install
  services used in web development such as nginx, haproxy, etc,
    ${bldgrn}$(basename $0) -a -t 'ruby python nodejs web aws docker'${txtrst}

  use a helper (not an installer) to wipe clean and reinstall postgresql
  from brew, create a new UTF8 database, and ensure it's running after.
    ${bldgrn}$(basename $0) -r reinstall-postgres${txtrst}

  wipe and reinstall homebrew, with additional ruby packages included
    ${bldgrn}$(basename $0) -r 'brew-wipe homebrew' -t ruby${txtrst}

  repair and install all brew packages, with additional python packages
    ${bldgrn}$(basename $0) -r 'brew-repair homebrew' -t python${txtrst}

  when installing brew packages, skip casks or linking, and only install
  formulas. Use verbose output.
    ${bldgrn}$(basename $0) -r homebrew -F -pv${txtrst}

  install everything, minus homebrew and sprout-wrap, but ALL features
  available. Since we are skipping homebrew, no feature-specific brew
  packages will be installed.
    ${bldgrn}$(basename $0) -aASB${txtrst}
"
}
